server {
  listen 8181;

  server_name healthcheck;

  default_type text/html;

  location ~* ^/status/([^/]+)$ {
    set $type $1;
    content_by_lua_block {
      local dynamic_upstream = require "ngx.dynamic_upstream"
      local stream_upstream  = require "ngx.upstream.stream"

      local upstream_module

      if ngx.var.type == "http" then
        upstream_module = {
          get_upstreams = dynamic_upstream.get_upstreams,
          get_peers = dynamic_upstream.get_peers
        }
      elseif ngx.var.type == "stream" then
        upstream_module = {
          get_upstreams = function()
            return true, stream_upstream.get_upstreams(), nil
          end,
          get_peers = function(upstream)
            local peers = {}
            local pp = stream_upstream.get_primary_peers(upstream)
            local bp = stream_upstream.get_backup_peers(upstream)
            if pp then
              for _, peer in pairs(pp)
              do
                peer.is_backup = false
                table.insert(peers, peer)
              end
            end
            if bp then
              for _, peer in pairs(bp)
              do
                peer.is_backup = true
                table.insert(peers, peer)
              end
            end
            return true, peers, nil
          end
        }
      else
        return;
      end

      local healthcheck = require "resty.upstream.dynamic.healthcheck"

      local HEALTHCHECK = ngx.shared.healthcheck

      local ok, upstreams, error = upstream_module.get_upstreams()

      if not ok then
        ngx.print(error)
      end

      local print_header_html = function(upstream)
        ngx.say("<tr>")
        ngx.say("  <td colspan=9 align=center><b>" .. upstream .. "</b></td>")
        ngx.say("</tr>")
      end

      local print_row_html = function(upstream, server, i)
        if server.name == "0.0.0.0:1" then
          ngx.say("<tr>")
          ngx.say("  <td colspan=9 align=center>no peers</td>")
          ngx.say("</tr>")
          return
        end
        local status = "up"
        local bgcolor = "green"
        if server.down ~= nil then
          status = "down"
          bgcolor = "red"
        end
        local typ = "primary"
        if server.backup then
          typ = "backup"
        end
        ngx.say("<tr>")
        ngx.say("  <td width=40 align=center>"  .. i .. "</td>")
        ngx.say("  <td width=400>" .. server.name .. "</td>")
        ngx.say("  <td width=150 align=center>" .. typ .. "</td>")
        ngx.say("  <td width=150 align=center>" .. server.weight .. "</td>")
        ngx.say("  <td width=150 align=center>" .. server.max_fails .. "</td>")
        ngx.say("  <td width=150 align=center>" .. server.fail_timeout .. "</td>")
        ngx.say("  <td width=150 align=center>" .. healthcheck.successes(HEALTHCHECK, upstream, server) .. "</td>")
        ngx.say("  <td width=150 align=center>" .. healthcheck.fails(HEALTHCHECK, upstream, server) .. "</td>")
        ngx.say("  <td width=100 align=center bgcolor=" .. bgcolor .. ">" .. status .. "</td>")
        ngx.say("</tr>")
      end

      local print_header_json = function(upstream, ctx)
        ctx[upstream] = {}
      end

      local print_row_json = function(upstream, server, ctx)
        local status = "up"
        if server.down ~= nil then
          status = "down"
        end
        table.insert(ctx[upstream], {
          server       = server.name,
          backup       = server.backup,
          weight       = server.weight,
          max_fails    = server.max_fails,
          fail_timeout = server.fail_timeout,
          successes    = healthcheck.successes(HEALTHCHECK, upstream, server),
          fails        = healthcheck.fails(HEALTHCHECK, upstream, server),
          status       = status
        })
      end

      local print_header_text = function(upstream)
        ngx.say(upstream)
      end

      local print_row_text = function(upstream, server)
        local status = "up"
        if server.down ~= nil then
          status = "down"
        end
        ngx.print("       server " .. server.name)
        ngx.print(      " backup=" .. server.backup)
        ngx.print(      " weight=" .. server.weight)
        ngx.print(   " max_fails=" .. server.max_fails)
        ngx.print(" fail_timeout=" .. server.fail_timeout)
        ngx.print(   " successes=" .. healthcheck.successes(HEALTHCHECK, upstream, server))
        ngx.print(       " fails=" .. healthcheck.fails(HEALTHCHECK, upstream, server))
        ngx.say  (      " status=" .. status)
      end

      local print_upstream = function(upstream, fmt)
        local ok, servers, error = upstream_module.get_peers(upstream)
        if not ok then
          ngx.print(error)
          return
        end

        fmt.header(upstream)

        for i, server in pairs(servers)
        do
          fmt.row(upstream, server, i)
        end
      end

      local f = {
        json = {
          ctx,
          beg = function()
            ctx = {}
          end,
          fin = function()
            local cjson = require "cjson"
            ngx.say(cjson.encode(ctx))
          end,
          header = function(upstream)
            print_header_json(upstream, ctx)
          end,
          row = function(upstream, server)
            print_row_json(upstream, server, ctx)
          end
        },
        text = {
          beg = function() end,
          fin = function() end,
          header = print_header_text,
          row = print_row_text
        },
        html = {
          beg = function()
            ngx.say("<!DOCTYPE html>")
            ngx.say("<html>")
            ngx.say("<head><title>Endpoint's statuses</title></head>")
            ngx.say("<body>")
            ngx.say("<table border=2>")
            ngx.say("<tr>")
            ngx.say("  <td width=40 align=center><b>N</b></td>")
            ngx.say("  <td width=400 align=center><b>ENDPOINT</b></td>")
            ngx.say("  <td width=150 align=center><b>TYPE</b></td>")
            ngx.say("  <td width=150 align=center><b>WEIGHT</b></td>")
            ngx.say("  <td width=150 align=center><b>MAX FAILS</b></td>")
            ngx.say("  <td width=150 align=center><b>FAIL TIMEOUT</b></td>")
            ngx.say("  <td width=150 align=center><b>SUCCESSES</b></td>")
            ngx.say("  <td width=150 align=center><b>FAILS</b></td>")
            ngx.say("  <td width=100 align=center><b>STATUS</b></td>")
            ngx.say("</tr>")
          end,
          fin = function()
            ngx.say("</table>")
            ngx.say("</body>")
            ngx.say("</html>")
          end,
          header = print_header_html,
          row = print_row_html
        }
      }

      local fmt = f.html

      if ngx.var.arg_format == "text" then
        fmt = f.text
        ngx.header.content_type = "text/plain"
      elseif ngx.var.arg_format == "json" then
        fmt = f.json
        ngx.header.content_type = "application/json"
      else
        ngx.header.content_type = "text/html"
      end

      fmt.beg()

      for _, upstream in pairs(upstreams)
      do
        print_upstream(upstream, fmt)
      end

      fmt.fin()
    }
  }
}
